<?php
/**
 * Created by PhpStorm.
 * User: jerry
 * Date: 2017/10/12
 * Time: 10:09
 */

namespace app\bo\libs;

use app\bo\model\BudgetColumn;
use app\bo\model\BudgetPermissions;
use app\bo\model\BudgetTable;
use app\bo\model\BudgetTemplate;

class BudgetEntity extends BoModel
{
    protected $searchable;
    protected $templateModel;
    protected $columnModel;
    protected $permissionsModel;
    protected $tableModel;
    protected $member;

    protected function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->templateModel = new BudgetTemplate();
        $this->columnModel = new BudgetColumn();
        $this->permissionsModel = new BudgetPermissions();
        $this->tableModel = new BudgetTable();
        $this->member = $this->getCurrent();
    }

    function saveTemplate($data)
    {
        $cols = $data['data'];
        $par = [
            "t_title" => $data['t_title'],
            "t_mid" => $this->member->m_id,
            "t_mname" => $this->member->m_name,
            "t_row" => $data['t_row'],
            "t_col" => $data['t_col'],
        ];
        if (!empty($data['tid'])) {
            $this->templateModel->isUpdate(true);
            $par["t_id"] = $data['tid'];
            $par['update_time'] = time();
        } else {
            $par['create_time'] = time();
            $par['update_time'] = $par['create_time'];
        }
        $result = $this->templateModel->save($par);
        if ($result) {
            $result = $this->columnModel->saveAll($this->formatColsToSQL($cols, $this->templateModel->t_id, 1));
        }
        return ($result ? true : false);
    }

    function getTemplateList($limit, $filter = false)
    {
        if ($this->member->m_isAdmin != 1) {
            $this->templateModel->where("t_mid", "=", $this->member->m_id);
        }
        $this->templateModel->order("update_time desc")->order("create_time desc");
        if ($filter !== false) {
            foreach ($filter as $key => $value) {
                $this->templateModel->where($key, $value['op'], $value['val']);
            }
        }
        if ($limit !== false) {
            $list = $this->templateModel->paginate($limit);
        } else {
            $list = $this->templateModel->select();
        }
        return $list;
    }

    function getTemplateByID($id, $needTable = false)
    {
        $model = $this->templateModel->where("t_id", "=", $id)->find();
        if ($needTable && $model) {
            $model->cols = $this->formatColsToJS($this->getColsByTid($model->t_id));
        }
        return $model;
    }

    function getTableList($limit, $filter = false)
    {
        if ($this->member->m_isAdmin != 1) {
            $this->tableModel->where("mid", "=", $this->member->m_id);
        }
        $this->tableModel->order("update_time desc")->order("create_time desc");
        if ($filter !== false) {
            foreach ($filter as $key => $value) {
                $this->tableModel->where($key, $value['op'], $value['val']);
            }
        }
        if ($limit !== false) {
            $list = $this->tableModel->paginate($limit);
        } else {
            $list = $this->tableModel->select();
        }
        return $list;
    }

    function saveTable($data)
    {
        $pcr = json_decode(urldecode($data['pcr']), true);
        unset($data['pcr']);
        if (!empty($data['id'])) {
            $this->tableModel->update(true);
            $data['update_time'] = time();
        } else {
            unset($data['id']);
            $data['create_time'] = time();
            $data['update_time'] = $data['create_time'];
            $data["mid"] = $this->member->m_id;
            $data["mname"] = $this->member->m_name;
        }
        $result = $this->tableModel->save($data);
        if ($result AND count($pcr) > 0) {
            $result = $this->saveTablePermissions($pcr, $this->tableModel->id);
        }
        return ($result ? true : false);
    }

    function saveTablePermissions($data, $id)
    {
        $this->permissionsModel->where("tid", "=", $id)->delete();
        $lists = [];
        foreach ($data as $value) {
            $tmp = [
                "tid" => $id,
                "mid" => $value['mid'],
                "cid" => $value['cid'],
                "rw" => $value['rw'],
            ];
            $lists[] = $tmp;
        }
        return $this->permissionsModel->saveAll($lists);
    }

    function getTableByID($id)
    {
        $model = $this->tableModel->where("id", "=", $id)->find();
        return $model;
    }

    function getColsByTid($id)
    {
        return $this->columnModel->where("c_tid", "=", $id)->select();
    }

    function formatColsToSQL($cols, $tid, $isTemplate = 0)
    {
        $colsTmp = [];
        foreach ($cols as $key => $value) {
            foreach ($value as $k => $val) {
                $tmp = [
                    "c_col" => $key,
                    "c_row" => $k,
                    "c_value" => $val['val'],
                    "c_colspan" => $val['colSpan'],
                    "c_rowspan" => $val['rowSpan'],
                    "c_display" => $val['display'],
                    "c_isTemplate" => $isTemplate,
                    "c_readonly" => $val['readonly'],
                    "c_tid" => $tid,
                ];
                if (!empty($val['cid'])) {
                    $tmp["c_id"] = $val['cid'];
                }
                $colsTmp[] = $tmp;
            }
        }
        return $colsTmp;
    }

    function formatColsToJS($cols)
    {
        $colsTmp = [];
        foreach ($cols as $val) {
            $colsTmp[$val['c_row']][] = $val;
        }
        return json_encode(array_values($colsTmp));
    }

    function getTableByTemplate($tid)
    {
        $data['table'] = $this->getTemplateByID($tid, true);
        $data['list'] = $this->tableModel->where("tid", "=", $tid)->select();
        return $data;
    }

    function getPermissionsByTable($id)
    {
        return $this->permissionsModel->where("tid", "=", $id)->select();
    }
}