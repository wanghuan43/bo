<!-- 弹窗 START -->
<div class="f-layer-back"
     style="display:none;background-color: black;opacity: 0.5;width: 100%;height: 100%;position: fixed;top: 0;"></div>
<div class="f-layer" style="display: none;">
    <form action="<{:url("/contract/searchContract")}>" id="searchForm">
    <div class="clearfix header">
        <h2>合同信息搜索条件:</h2>
        <div class="btn-pannel">
            <button class="btn save">保存</button>
            <button class="btn red close">取消</button>
            <button class="btn search" type="submit">搜索</button>
        </div>
    </div>
    <div class="search-condition">
        <{for start="0" end="$searchable.length"}>
        <div class="search-block">
            <select class="fields" name="fields[<{$i}>]">
                <?php $ii=0;foreach($searchable['fields'] as $key=>$value): ?>
                <option value="<{$key}>" <{eq name="$ii" value="$i"}>selected<{/eq}> data="<{$value.type}>"><{$value.name}></option>
                <?php $ii++; ?>
                <?php endforeach ?>
            </select>
            <select class="operators" name="operators[<{$i}>]">
            </select>
            <input type="text" id="<?php echo "tmp",mt_rand(1000,100000); ?>" name="values[<{$i}>][]" value=""/>
        </div>
        <{/for}>
    </div>
    </form>
    <div id="contractSearch">
        <div class="clearfix header searchTitle" style="display: none;">
            <h2></h2>
            <div class="btn-pannel paginate">
            </div>
        </div>
        <div class="search-result">
            <table cellspacing="0" class="list">
                <thead>
                <tr>
                    <th></th>
                    <th>合同号</th>
                    <th>合同名称</th>
                    <th>对方名称</th>
                    <th>签约日期</th>
                    <th>合同金额</th>
                    <th>未对应订单金额</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td colspan="7">请设置条件,点击搜索</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- 弹窗 END -->
<script>
    var operators = <?php echo json_encode($searchable['operators']); ?>;
    var fields = <?php echo json_encode($searchable['fields']); ?>;
    var datePlugin = {};
    $(document).ready(function(){
        $('.fields').change(function(){
            var val = $(this).val();
            var ts = this;
            var lists = eval("operators."+val);
            var opt = "";
            for(var i in lists){
                opt += "<option value=\""+i+"\">"+lists[i]+"</option>";
            }
            $(this).next().html(opt);
            operatorsChange($(this).next());
        });
        $('.operators').change(function(){
            operatorsChange(this);
        });
        $('.fields').change();
        $("#searchForm").submit(function(){
            var data = $(this).serialize();
            $.ajax({
                url: "<{:url("/contract/searchContract")}>",
                dataType: "json",
                method: "post",
                data: data,
                success: function (data) {
                    $("#contractSearch").html(data.content);
                }
            });
            return false;
        });
    });
    function operatorsChange(ele){
        var opt = $(ele).val();
        var type = $(ele).prev().find("option:selected").attr("data");
        var id = '#'+$(ele).parent().find("input").attr("id");
        var input = $(ele).parent().find("input");
        switch (type){
            case 'date':
                setDateField(id, opt, input);
            default:
                cutInput(input,opt,type);
                break;
        }
    }
    function cutInput(input,opt,type){
        $(input).attr("fliter", type);
        $(input).val("");
        var tmp = $(input).clone();
        var id = $(input).attr("id");
        var inputs = $(input).parent().find("input");
        var it = id.replace("#","");
        var parent = $(input).parent();
        if(type != "date"){
            if(datePlugin[it] != undefined) {
                delete datePlugin[it];
                $(input).remove();
                $(parent).append(tmp);
            }
            $(input).removeAttr("readonly");
            if(opt=="between"){
                $(input).css("width", "100px");
                $(input).attr("id", id+"-1");
                $(tmp).css("width", "100px");
                $(tmp).attr("id", id+"-2");
                $(input).parent().append(tmp);
            }else{
                if(inputs.length > 1){
                    $(inputs).eq("1").remove();
                    $(input).css("width", "200px");
                    $(input).attr("id", id.replace("-1", ""));
                }
            }
        }else{
            $(input).attr("readonly");
            var inputs = $(input).parent().find("input");
            if(inputs.length > 1){
                $(inputs).eq("1").remove();
                $(input).css("width", "200px");
                $(input).attr("id", id.replace("-1", ""));
            }
        }
    }
    function setDateField(id,opt,input){
        var range = false;
        var it = id.replace("#","");
        var val = $(input).val();
        if(opt == "between"){
            range = "~";
        }
        if(datePlugin[it] != undefined){
            datePlugin[it].config.range = range;
            if(range === false && val.indexOf("~") > 0){
                $(input).val(val.substr(0, val.indexOf("~")-1));
            }else if(range !== false && val.indexOf("~") < 0){
                $(input).val("");
            }
        }else{
            var tmp = laydate.render({
                elem:id,
                range:range,
                value:val
            });
            datePlugin[it] = tmp;
        }
    }
</script>