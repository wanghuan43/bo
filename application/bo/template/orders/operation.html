<{load href="/static/css/select.min.css,/static/css/jquery-ui.min.css"/}>
<form action="/orders/doOperation?op=<{$op}>&op_id=<{$op_id}>" method="post" id="opform"
      xmlns="http://www.w3.org/1999/html">
<div class="clearfix header">
    <h2>订单（<{if $order.o_status==6}>签约<{else}>预计<{/if}>）</h2>
    <div class="btn-pannel">
        <{if condition="$isAdmin"}>
        <button type="button" href="#historyBack" class="btn red">取消</button>
        <button type="submit" class="btn">保存</button>
        <{/if}>
    </div>
    <div class="link-pannel">
        <ul>
            <{if condition="$op != 'add'"}>
            <{if condition="$isAdmin"}>
            <li>
                <a href="<{:url("/orders/myLogList/opId/".$op_id)}>"><i class="fa fa-calendar-check-o"></i>日志</a>
            </li>
            <{/if}>
            <li>
                <a href="<{:url("/postil/index/opID/".$op_id)}>"><i class="fa fa-pencil"></i>批注</a>
            </li>
            <!--<li>-->
                <!--<a href="#"><i class="fa fa-share-square-o"></i>分享</a>-->
            <!--</li>-->
            <li>
                <a href="#" id="favorite" data="<{$isFavorite}>"><i class="fa fa-star"></i><{if condition="empty($isFavorite)"}>收藏<{else/}>取消收藏<{/if}></a>
            </li>
            <{/if}>
        </ul>
    </div>
</div>
<div class="main-pannel">
    <h3>基本信息</h3>
    <div class="content">
        <table class="detail order-detail">
            <tr>
                <td class="txt"><label>订单号:</label></td>
                <td colspan="3"><{$order.o_no}></td>
                <td class="txt">
                    <label for="o_cno">
                    <{/*i class="fa fa-search" data="contract"></i>
                    <i class="fa fa-minus-square" style="color: red;display: none;" data="contract"></i*/}>
                    对应合同号:</label></td>
                <td>
                    <input class="input-sm input-search" data="contract" type="text" name="o_cno" id="o_cno" value="<{$order.o_cno}>" readonly/>
                    <input type="hidden" name="o_cid" id="o_cid" value="<{$order.o_cid}>"/>
                </td>
                <td class="txt"><label>最后更新日期:</label></td>
                <td><?php echo (empty($order['o_updatetime']) ? date("Y-m-d") : date("Y-m-d", $order['o_updatetime']));?></td>
            </tr>
            <tr>
                <td class="txt">
                    <label for="o_pname"><i class="asterisk">*</i>项目名称:</label>
                </td>
                <td colspan="5">
                    <input class="input-sm input-search" data="project" type="text" name="o_pname" id="o_pname" value="<{$order.o_pname}>" readonly required/>
                    <input type="hidden" name="o_pid" id="o_pid" value="<{$order.o_pid}>"/>
                </td>
                <td class="txt"><label for="o_mname">订单责任人:</label></td>
                <td>
                    <{if condition="empty($order.o_mname)"}><{$mn}><{else}><{$order.o_mname}><{/if}>
                    <input class="input-sm" type="hidden" name="o_mname" id="o_mname" value="<{$order.o_mname}>"/>
                    <input type="hidden" name="o_mid" id="o_mid" value="<{$order.o_mid}>"/>
                </td>
            </tr>
            <tr>
                <td class="txt"><label for="o_subject"><i class="asterisk">*</i>订单摘要:</label></td>
                <td colspan="5"><input class="input-sm" type="text" name="o_subject" id="o_subject" value="<{$order.o_subject}>" required/></td>
                <td class="txt"><label for="o_type">收入/支出:</label></td>
                <td>
                    <select class="input-sm" name="o_type" id="o_type" <{if condition="!empty($order.o_type)"}>disabled<{/if}>>
                        <{foreach name="typeList" id="tl"}>
                        <option value="<{$key}>" <{eq name="$key" value="$order.o_type"}>selected<{/eq}>><{$tl}></option>
                        <{/foreach}>
                    </select>
                </td>
            </tr>
            <tr>
                <td class="txt">
                    <label for="o_coname"><i class="asterisk">*</i>对方名称:</label>
                </td>
                <td colspan="3">
                    <input class="input-sm input-search" data="company" name="o_coname" id="o_coname" type="text" value="<{$order.o_coname}>" readonly required/>
                    <input type="hidden" name="o_coid" id="o_coid" value="<{$order.o_coid}>"/>
                </td>
                <td class="txt"><label for="o_lie">外部/内部:</label></td>
                <td>
                    <select class="input-sm" name="o_lie" id="o_lie" <{if condition="!empty($order.o_lie)"}>disabled<{/if}>>
                        <{volist name="lieList" id="ll"}>
                        <option value="<{$key}>" <{eq name="$key" value="$order.o_lie"}>selected<{/eq}>><{$ll}></option>
                        <{/volist}>
                    </select>
                </td>
                <td class="txt"><label for="o_did">部门:</label></td>
                <td>
                    <select class="input-sm pop" name="o_did" id="o_did" data="o_did">
                        <{if condition="!empty($op_id)"}>
                        <option selected value="<{$order.o_did}>"><{$order.o_dname}></option>
                        <{/if}>
                    </select>
                    <input type="hidden" name="o_dname" id="o_dname" value="<{$order.o_dname}>"/>
                </td>
            </tr>
            <tr class="zproject" style="display: none">
                <td class="txt">
                    <label for="zc_name"><i class="asterisk">*</i>支出项目:</label>
                </td>
                <td colspan="5">
                    <input class="input-sm input-search" data="project" name="zc_name" id="zc_name" type="text" value="" readonly/>
                    <input type="hidden" name="zc_id" id="zc_id" value=""/>
                    <input type="hidden" name="zc_did" id="zc_did" value=""/>
                    <input type="hidden" name="zc_dname" id="zc_dname" value=""/>
                </td>
                <td class="txt">
                    <label for="zc_mid">支出责任人:</label>
                </td>
                <td>
                    <select class="input-sm pop" name="zc_mid" id="zc_mid" data="zc_mid">

                    </select>
                    <input type="hidden" name="zc_mname" id="zc_mname" value=""/>
                </td>
            </tr>
            <tr>
                <td class="txt"><label for="o_date"><i class="asterisk">*</i><{if condition="$op=='add'"}>预计日期:<{else /}>签约日期:<{/if}></label></td>
                <td><input class="input-sm" type="text" name="o_date" id="o_date" value="<?php echo (empty($order['o_date']) ? "" : date("Y-m-d", $order['o_date'])) ?>" required/></td>
                <td class="txt"><label for="o_money"><i class="asterisk">*</i><{if condition="$op=='add'"}>预计总金额:<{else /}>合同总金额:<{/if}></label></td>
                <td><input class="input-sm" type="text" name="o_money" id="o_money" value="<{$order.o_money}>" required number="true"/></td>
                <!--<td><input type="text" name="o_money" id="o_money" value="1233"/></td>-->
                <td class="txt"><label for="o_num"><i class="asterisk">*</i>数量:</label></td>
                <td><input class="input-sm" type="text" name="o_num" id="o_num" value="<{$order.o_num}>" required/></td>
                <td class="txt"><label for="o_tax">税率:</label></td>
                <td>
                    <select class="input-sm" name="o_tax" id="o_tax">
                        <{volist name="taxList" id="ll"}>
                        <option value="<{$key}>" <{if ($key == $order.o_tax) OR (empty($order.o_tax) AND $key==3)}>selected<{/if}>><{$ll}></option>
                        <{/volist}>
                    </select>
                </td>
            </tr>
            <tr>
                <td class="txt"><label for="o_deal">成交机会:</label></td>
                <td>
                    <select class="input-sm" name="o_deal" id="o_deal">
                        <{volist name="chancesList" id="cl"}>
                        <option value="<{$cl.cs_id}>" <{eq name="$cl.cs_id" value="$order.o_deal"}>selected<{/eq}>><{$cl.cs_name}></option>
                        <{/volist}>
                    </select>
                </td>
                <td class="txt"><label for="o_status">商机状态:</label></td>
                <td>
                    <select class="input-sm" name="o_status" id="o_status">
                        <{volist name="statusList" id="ll"}>
                        <option value="<{$key}>" <{eq name="$key" value="$order.o_status"}>selected<{/eq}>><{$ll}></option>
                        <{/volist}>
                    </select>
                </td>
                <td class="txt"><label for="o_profits">利润率:</label></td>
                <td>
                    <input class="input-sm" type="text" name="o_profits" id="o_profits" value="<{$order.o_profits}>"/>
                </td>
            </tr>
            <tr>
                <td class="txt"><label for="tagList">关键字/标签:</label></td>
                <td colspan="3">
                    <select class="mstag pop" multiple id="tagList" name="tagList[]" data="tagList">
                        <{foreach $tagIDList as $key=>$value}>
                        <option value="<{$key}>" selected><{$value}></option>
                        <{/foreach}>
                    </select>
                </td>
                <td class="txt"><label for="cList">传阅人:</label></td>
                <td colspan="3">
                    <select class="msmember pop" multiple id="cList" name="cList[]" data="cList">
                        <{foreach $cIDList as $key=>$value}>
                        <option value="<{$key}>" selected><{$value}></option>
                        <{/foreach}>
                    </select>
                </td>
            </tr>
        </table>
    </div>
</div>
<div class="main-pannel" <{if condition="$order['o_status'] != '6'"}>style="display:none;"<{/if}>>
    <h3>实际发生情况</h3>
    <div class="content table clearfix">
        <div class="col33">
            <table class="invoice_1" data="1">
                <thead>
                <tr>
                    <td><i class="fa fa-search" data="invoice"></i></td>
                    <td>&#931;已开票</td>
                    <td>0.00</td>
                    <td>0%</td>
                </tr>
                <tr class="thead">
                    <td></td>
                    <td>开票日期</td>
                    <td>金额</td>
                    <td>凭证</td>
                </tr>
                </thead>
                <tbody>
                <{if condition="count($oused[1]) >= 1"}>
                <{volist name="oused[1]" id="value" key="k"}>
                <tr>
                    <td>
                        <i class="fa fa-minus-circle" data="<{$value['ou_id']}>"></i>
                    </td>
                    <td><?php echo date("Y-m-d", $value['ou_date']); ?></td>
                    <td class="mony-invoice"><{$value['ou_used']}></td>
                    <td>
                        <a href="/#invoice/detail?id=<{$value['ou_otid']}>" target="_blank" style="color: blue;"><{$value['ou_otid']}></a>
                        <input type="hidden" name="used[1][date][]" value="<?php echo date("Y-m-d", $value['ou_date']); ?>">
                        <input type="hidden" name="used[1][value][]" value="<{$value['ou_used']}>">
                        <input type="hidden" name="used[1][ot_id][]" value="<{$value['ou_oid']}>">
                    </td>
                </tr>
                <{/volist}>
                <{/if}>
                </tbody>
            </table>
        </div>
        <div class="col33">
            <table class="acceptance_2" data="2">
                <thead>
                <tr>
                    <td><i class="fa fa-search" data="acceptance"></i></td>
                    <td>&#931;已交付</td>
                    <td>0.00</td>
                    <td>0%</td>
                </tr>
                <tr class="thead">
                    <td></td>
                    <td>交付日期</td>
                    <td>金额</td>
                    <td>凭证</td>
                </tr>
                </thead>
                <tbody>
                <{if condition="count($oused[2]) >= 1"}>
                <{volist name="oused[2]" id="value" key="k"}>
                <tr>
                    <td>
                        <i class="fa fa-minus-circle" data="<{$value['ou_id']}>"></i>
                    </td>
                    <td><?php echo date("Y-m-d", $value['ou_date']); ?></td>
                    <td class="mony-acceptance"><{$value['ou_used']}></td>
                    <td>
                        <a href="/#acceptance/detail?id=<{$value['ou_otid']}>" target="_blank" style="color: blue;"><{$value['ou_otid']}></a>
                        <input type="hidden" name="used[2][date][]" value="<?php echo date("Y-m-d", $value['ou_date']); ?>">
                        <input type="hidden" name="used[2][value][]" value="<{$value['ou_used']}>">
                        <input type="hidden" name="used[2][ot_id][]" value="<{$value['ou_oid']}>">
                    </td>
                </tr>
                <{/volist}>
                <{/if}>
                </tbody>
            </table>
        </div>
        <div class="col33">
            <table class="received_3" data="3">
                <thead>
                <tr>
                    <td><i class="fa fa-search" data="received"></i></td>
                    <td>&#931;已付款</td>
                    <td>0.00</td>
                    <td>0%</td>
                </tr>
                <tr class="thead">
                    <td></td>
                    <td>付款日期</td>
                    <td>金额</td>
                    <td>凭证</td>
                </tr>
                </thead>
                <tbody>
                <{if condition="count($oused[3]) >= 1"}>
                <{volist name="oused[3]" id="value" key="k"}>
                <tr>
                    <td>
                        <i class="fa fa-minus-circle" data="<{$value['ou_id']}>"></i>
                    </td>
                    <td><?php echo date("Y-m-d", $value['ou_date']); ?></td>
                    <td class="mony-received"><{$value['ou_used']}></td>
                    <td>
                        <a href="/#received/detail?id=<{$value['ou_otid']}>" target="_blank" style="color: blue;"><{$value['ou_otid']}></a>
                        <input type="hidden" name="used[3][date][]" value="<?php echo date("Y-m-d", $value['ou_date']); ?>">
                        <input type="hidden" name="used[3][value][]" value="<{$value['ou_used']}>">
                        <input type="hidden" name="used[3][ot_id][]" value="<{$value['ou_oid']}>">
                    </td>
                </tr>
                <{/volist}>
                <{/if}>
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="main-pannel">
    <h3>预计执行计划</h3>
    <div class="content table clearfix">
        <div class="col33">
            <table data="1" style="border-collapse: separate;border-spacing: 0px 10px;">
                <thead>
                <tr>
                    <th class="icon"><i class="fa fa-plus"></i></th>
                    <th style="width: 64px;">开票月</th>
                    <th>比例</th>
                    <th style="width: 94px;">金额</th>
                </tr>
                </thead>
                <tbody>
                <{if condition="count($opject[1]) >= 1"}>
                <{volist name="opject[1]" id="value" key="k"}>
                <tr>
                    <td class="icon"><i class="fa fa-remove"></i></td>
                    <td>
                        <select class="orderProject_month_1" name="project[1][month][]">
                            <option value="<{$value.op_month}>" selected><{$value.op_month}></option>
                        </select>
                    </td>
                    <td>
                        <div class="slider" style="margin: 0 20px;"></div>
                        <input class="orderProject_percent_1 sliderPercent" name="project[1][percent][]" type="text" style="display: none;" value="<{$value.op_used}>">
                    </td>
                    <td><input type="text" class="orderProject_value_1 sliderValue" name="project[1][value][]" style="margin-left: 10px;" value="<{$value.op_used}>"/></td>
                </tr>
                <{/volist}>
                <{else /}>
                <tr>
                    <td class="icon"></td>
                    <td>
                        <select class="orderProject_month_1" name="project[1][month][]">
                        </select>
                    </td>
                    <td>
                        <div class="slider" style="margin: 0 20px;">
                        </div>
                        <input class="orderProject_percent_1 sliderPercent" name="project[1][percent][]" style="display: none;" type="text" value="0">
                    </td>
                    <td><input type="text" class="orderProject_value_1 sliderValue" style="margin-left: 10px;" name="project[1][value][]" value="0"/></td>
                </tr>
                <{/if}>
                </tbody>
            </table>
        </div>
        <div class="col33">
            <table data="2" style="border-collapse: separate;border-spacing: 0px 10px;">
                <thead>
                <tr>
                    <th class="icon"><i class="fa fa-plus"></i></th>
                    <th style="width: 64px;">交付月</th>
                    <th>比例</th>
                    <th style="width: 94px;">金额</th>
                </tr>
                </thead>
                <tbody>
                <{if condition="count($opject[2]) >= 1"}>
                <{volist name="opject[2]" id="value" key="k"}>
                <tr>
                    <td class="icon"><i class="fa fa-remove"></i></td>
                    <td>
                        <select class="orderProject_month_2" name="project[2][month][]">
                            <option value="<{$value.op_month}>" selected><{$value.op_month}></option>
                        </select>
                    </td>
                    <td>
                        <div class="slider" style="margin: 0 20px;">
                        </div>
                        <input class="orderProject_percent_2 sliderPercent" name="project[2][percent][]" style="display: none;" type="text" value="<{$value.op_used}>">
                    </td>
                    <td><input type="text" class="orderProject_value_2 sliderValue" name="project[2][value][]" style="margin-left: 10px;" value="<{$value.op_used}>"/></td>
                </tr>
                <{/volist}>
                <{else /}>
                <tr>
                    <td class="icon"></td>
                    <td>
                        <select class="orderProject_month_2" name="project[2][month][]">
                        </select>
                    </td>
                    <td>
                        <div class="slider" style="margin: 0 20px;">
                        </div>
                        <input class="orderProject_percent_2 sliderPercent" name="project[2][percent][]" style="display: none;" type="text" value="0">
                    </td>
                    <td><input class="orderProject_value_2 sliderValue" name="project[2][value][]" style="margin-left: 10px;" type="text" value="0"/></td>
                </tr>
                <{/if}>
                </tbody>
            </table>
        </div>
        <div class="col33">
            <table data="3" style="border-collapse: separate;border-spacing: 0px 10px;">
                <thead>
                <tr>
                    <th class="icon"><i class="fa fa-plus"></i></th>
                    <th style="width: 64px;">付款月</th>
                    <th>比例</th>
                    <th style="width: 94px;">金额</th>
                </tr>
                </thead>
                <tbody>
                <{if condition="count($opject[3]) >= 1"}>
                <{volist name="opject[3]" id="value" key="k"}>
                <tr>
                    <td class="icon"><i class="fa fa-remove"></i></td>
                    <td>
                        <select class="orderProject_month_3" name="project[3][month][]">
                            <option value="<{$value.op_month}>" selected><{$value.op_month}></option>
                        </select>
                    </td>
                    <td>
                        <div class="slider" style="margin: 0 20px;">
                        </div>
                        <input class="orderProject_percent_3 sliderPercent"  name="project[3][percent][]" style="display: none;" value="<{$value.op_used}>">
                    </td>
                    <td><input type="text" class="orderProject_value_3 sliderValue" name="project[3][value][]" style="margin-left: 10px;" value="<{$value.op_used}>"/></td>
                </tr>
                <{/volist}>
                <{else /}>
                <tr>
                    <td class="icon"></td>
                    <td>
                        <select class="orderProject_month_3" name="project[3][month][]">
                        </select>
                    </td>
                    <td>
                        <div class="slider" style="margin: 0 20px;">
                        </div>
                        <input class="orderProject_percent_3 sliderPercent" name="project[3][percent][]" style="display: none;" type="text" value="0">
                    </td>
                    <td><input type="text" class="orderProject_value_3 sliderValue" name="project[3][value][]" style="margin-left: 10px;" value="0"/></td>
                </tr>
                <{/if}>
                </tbody>
            </table>
        </div>
    </div>
</div>
</form>
<{load href="/static/js/plugin/select/select.min.js,/static/js/jquery-ui.custom.js"/}>
<script>
    var baseMonth = '<{$baseMonth}>';
    var baseUrl = {
        contract: "<{:url('/contract/searchContract')}>",
        project: "<{:url('/project/searchProject')}>",
        company: "<{:url('/company/searchCompany')}>",
        department: "<{:url('/department/searchDepartment')}>",
        invoice: "<{:url('/invoice/searchInvoice')}>",
        acceptance: "<{:url('/acceptance/searchAcceptance')}>",
        received:"<{:url('/received/searchReceived')}>",
    };

    var zproject = {
        show:function(){
            $("#zc_name").attr("required","true");
            $("#opform .zproject").show();
        },
        hide:function(){
            $("#zc_name").removeAttr("required");
            $("#opform .zproject").hide();
        }
    };

    $(document).ready(function () {
//    <{if condition="!empty($op_id)"}>
//        $("#o_deal option").each(function(index, element){
//            if(parseInt($(element).val()) < parseInt("<{$order.o_deal}>")){
//                $(element).prop("disabled", true);
//            }
//        });
//        $("#o_status option").each(function(index, element){
//            if(parseInt($(element).val()) < parseInt("<{$order.o_status}>")){
//                $(element).prop("disabled", true);
//            }
//        });
//    <{/if}>
        bindRemove();
        $("#o_type").change(function(){
            var cla = ".f-layer-company",lie = $("#o_lie").val();
            $(cla).remove();
            $(cla + "-back").remove();
            if($(this).val() == "2" && lie == "1"){
                zproject.show();
            }else{
                zproject.hide();
            }
        });
        $("#o_type").change();
        $("#zc_mid").change(function(){
            $("#zc_mname").val($("#zc_mid option:selected").text());
        });
        $("#zc_mid").change();
        $("#zc_did").change(function(){
            $("#zc_dname").val($("#zc_did option:selected").text());
        });
        $("#zc_did").change();
        $("#o_profits").change(function(){
            if($(this).val().indexOf("%") < 0){
                $(this).val($(this).val()+"%");
            }
        });
        $("#favorite").click(function(){
            var url = "<{:url("/favorite/saveFavorite/opID/".$op_id)}>"
            var val = $(this).attr("data");
            var ele = $(this);
            $.ajax({
                url: url,
                data: "save="+val,
                method: "post",
                type: "json",
                success: function (data) {
                    if(val == "1"){
                        ele.html('<i class="fa fa-star"></i>收藏');
                        ele.attr("data", "0");
                    }else{
                        ele.html('<i class="fa fa-star"></i>取消收藏');
                        ele.attr("data", "1");
                    }
                    custom.alert(data.message);
                }
            });
            return false;
        });
        laydate.render({
            elem: '#o_date'
        });
        $("table[data='1']:eq(1),table[data='2']:eq(1),table[data='3']:eq(1)").each(function(index, element){
            if($(element).find("tr").length == 2){
                $(element).find(".fa-remove").remove();
            }
        });
        if($("#o_status option:selected").val() == 6){
            $("#o_status option").prop("disabled", true);
            $("#o_status option:last").prop("disabled", false);
        }
        $(".content.table .slider").each(function(index, element){
            var val = $(element).parent().next().find("input").val() != "" ? parseFloat($(element).parent().next().find("input").val()) : 0;
            sliderElement(element, val, index);
        });
        $(".content.table select").each(function(index, element){
            var option = $(element).find("option:selected").val();
            var bm = JSON.parse(baseMonth);
            var len = bm.length;
            var html = "";
            for (var i = 0; i < len; i++) {
                html += '<option value="+' + bm[i] + '" ' + (option=="+"+bm[i] ? "selected" : "") + '>+ ' + bm[i] + '</option>';
            }
            html += '<option value="0 M" ' + (option=="0 M" ? "selected" : (option == undefined ? "selected" : "")) + '>0 M</option>';
            for (var i = (len - 1); i >= 0; i--) {
                html += '<option value="-' + bm[i] + '" ' + (option=="-"+bm[i] ? "selected" : "") + '>- ' + bm[i] + '</option>';
            }
            $(element).html(html);
        });
        $(".fa-remove").click(function () {
            $(this).parents("tr").remove();
        });
        $("#o_did").change(function(){
            $("#o_dname").val($("#o_did option:selected").html());
        });
        $("#o_did").change();
        $(".pop").select2();
        $(".pop").on("select2:open", function(e){
            var current = $(e.currentTarget),mul=current.prop("multiple"),type=current.attr("data"),url="",cla="",
                hidden="",selectC="";
            switch (type){
                case "o_did":
                    url = "/department/searchDepartment?mul="+mul+"&pop=true";
                    cla = ".f-layer-department";
                    hidden = "o_dname";
                    break;
                case "zc_did":
                    url = "/department/searchDepartment?mul="+mul+"&pop=true";
                    cla = ".f-layer-department";
                    hidden = "zc_dname";
                    break;
                case "zc_mid":
                    url = "/member/searchMember?type=" + mul + "&pop=true";
                    cla = ".f-layer-member";
                    hidden = "zc_mname";
                    break;
                case "cList":
                    url = "/member/searchMember?pop=true";
                    cla = ".f-layer-member";
                    selectC = "cList";
                    break;
                case "tagList":
                    url = "/taglib/searchTaglib?mul="+mul+"&pop=true";
                    cla = ".f-layer-taglib";
                    selectC = "tagList";
                    break;
                default:
                    url = false;
                    break;
            }
            if(url == false){
                return false;
            }
            loading.show();
            $.ajax({
                url:url,
                dataType: "json",
                method: "post",
                success:function(data){
                    $("#popDIV").html(data.content);
                    loading.hide();
                    if(mul == true) {
                        $("#sel-ids").select2();
                        $("#checked-result").show();
                    }
                    $(cla).addClass("show");
                    $(cla + "-back").show();
                    $(cla + " .close").click(function () {
                        $(cla).removeClass("show");
                        $(cla + "-back").hide();
                        return false;
                    });
                    $(cla + " .save").click(function () {
                        if($(cla+" table input:checked").length == 0){
                            custom.alert("请至少选择一个再保存！");
                            return false;
                        }
                        if(mul){
                            var options = "",old = $("#"+selectC+" option:selected");
                            $("#sel-ids option:selected").each(function(i,ele){
                                var rr = true;
                                old.each(function(ii,ee){
                                    if($(ee).val() == $(ele).val()){
                                        rr = false;
                                    }
                                });
                                if(rr) {
                                    options += '<option value="' + $(ele).val() + '" selected>' + $(ele).html().replace(/<[^>]+>/g, "") + '</option>';
                                }
                            });
                            $(current).append(options);
                        }else{
                            var options = "";
                            $(cla+" table input:checked").each(function(i,ele){
                                options += '<option value="'+$(ele).val()+'" selected>'+$(ele).parent().next().html().replace(/<[^>]+>/g,"")+'</option>';
                                $("#"+hidden).val($(ele).parent().next().html().replace(/<[^>]+>/g,""));
                            });
                            $(current).html(options);
                        }
                        $(cla).removeClass("show");
                        $(cla + "-back").hide();
                        return false;
                    });
                },
                error:function () {
                    loading.hide();
                    custom.alert("页面加载出错，请联系管理员！");
                }
            });
            return false;
        });
        initUsed();
        $("#o_money").change(function () {
            var val = $(this).val().replace(",","");
            if(isNaN(val) === true){
                custom.alert("合同金额只能是数字");
                $(this).val(0);
                calculateAll();
                return false;
            }
            var max = $(this).attr("max");
            if(max != undefined){
                max = parseFloat(max);
                if(max < $(this).val()){
                    custom.alert("合同的可用额度不够，不能超过"+max.toFixed(2));
                    $(this).val(max.toFixed(2));
                }
            }
            $(this).val(val);
            calculateAll();
        });
        $(".fa-plus").click(function () {
            var table = $(this).parents("table");
            bindClick(table);
        });
        $(".sliderValue").each(function(index, element){
            $(element).change(function(){
                valueChange(this);
            });
        });
        $(".content:eq(0) input").focus(function(){
            $(this).removeClass("wrong");
            $(this).next(".wrongMsg").remove();
        });
        $("#opform [type=submit]").click(function(){
            var form = $("#opform");
            form.validate({
                'submitHandler':function(){
                    var o_pname = $("#o_pname"),o_subject = $("#o_subject"),
                        o_coname = $("#o_coname"),o_date = $("#o_date"),o_money = $("#o_money"),o_num = $("#o_num"),
                        o_profits = $("#o_profits"),url = form.attr("action"),par = form.serialize(),check=false;
                    form.prop("disabled", "true");
                    loading.show();
                    $.ajax({
                        url:url,
                        dataType: "json",
                        method: "post",
                        data:par,
                        success:function(data){
                            loading.hide();
                            form.prop("disabled", "false");
                            custom.alert(data.message);
                            if(data.status){
                                window.setTimeout("location.reload()", 800);
                            }
                        },
                        error:function () {
                            loading.hide();
                            form.prop("disabled", "false");
                            custom.alert("提交出错，请联系管理员！");
                        }
                    });
                }
            });
        });

        $(".fa-search").click(function () {
            var type = $(this).attr("data"),thisEle = this,inputs = $(this).parent().next().find("input"),
                valss = $(inputs).val(),otype = $("#o_type").val(),olie = $("#o_lie").val(),url = ""
                per = $(this).parents("tr").find("td:last").html();
            if(valss != "" && valss != undefined){
                $(this).hide();
                $(this).next().show();
                return false;
            }
            if(per == "100.00%"){
                return false;
            }
            if(type == "contract" || type == "company"){
                if(type == "company"){
                    if(olie == "2" ){
                        type = "department";
                    }else{
                        type = "company";
                    }
                }
                url = baseUrl[type] + "?c_type="+otype+"&fi=1";
            }else{
                url = baseUrl[type] + "?fi=1";
            }
            var cla = ".f-layer-" + type;
            $.ajax({
                url: url,
                dataType: "json",
                method: "post",
                success: function (data) {
                    $("#popDIV").html(data.content);
                    $(cla + " .save").click(function () {
                        if($(cla+" .selectRadio:checked").length == 0){
                            custom.alert("请选择一个再保存！");
                            return false;
                        }
                        if ($(inputs).length > 1) {
                            $(inputs).eq(0).val($(cla+" .selectRadio:checked").attr("data"));
                            $(inputs).eq(1).val($(cla+" .selectRadio:checked").val());
                        } else {
                            $(inputs).eq(0).val($(cla+" .selectRadio:checked").val());
                        }
                        $(cla).removeClass("show");
                        $(cla + "-back").hide();
                        $(thisEle).next().show();
                        $(thisEle).hide();
                        $(thisEle).parent().next().find("input:eq(0)").unbind("focus");
                        if(type == "contract" && $(inputs).length > 1){
                            $("#o_status option").prop("selected", false);
                            $("#o_status option").prop("disabled", true);
                            $("#o_status option:last").prop("selected", true);
                            $("#o_status option:last").prop("disabled", false);
                            $("#o_status").prop("", true);
                            var json = JSON.parse(decodeURIComponent($(cla + " .selectRadio:checked").attr("data-value")));
                            if($("#o_money").val() == ""){
                                $("#o_money").val(json.c_noused);
                            }else{
                                var nu = parseFloat(json.c_noused),mo = parseFloat($("#o_money").val());
                                if(nu < mo){
                                    custom.alert("当前订单金额，超过合同的可用金额:"+nu.toFixed(2));
                                    $("#o_money").val(nu.toFixed(2));
                                }
                            }
                            $("#o_money").attr("max",parseFloat(json.c_noused));
                            if($("#o_pname").val() == ""){
                                $("#o_pname").val(json.c_pname);
                                $("#o_pname").click();
                                $("#o_pid").val(json.c_pid);
                            }
                            if($("#o_coname").val() == ""){
                                $("#o_coname").val(json.c_coname);
                                $("#o_coname").click();
                                $("#o_coid").val(json.c_coid);
                            }
                        }
                        return false;
                    });
                    $(cla + " .moreSave").click(function(){
                        var ci = $(cla + " .search-result input:checked");
                        if(ci.length > 0){
                            var jdata = JSON.parse(decodeURIComponent($(ci).attr("json"))),classT="",checkT=false;
                            switch (type){
                                case "invoice":
                                    classT = type+"_1";
                                    break;
                                case "acceptance":
                                    classT = type+"_2";
                                    break;
                                case "received":
                                    classT = type+"_3";
                                    break;
                            }
                            $("."+classT+" .fa-minus-circle").each(function(index, element){
                                if($(element).attr("data") == jdata.id){
                                    custom.alert("当前凭证已经选择过，不可重复选择！");
                                    checkT = true;
                                    return false;
                                }
                            });
                            if(checkT){
                                return false;
                            }
                            baseUTR($(cla), jdata, type);
                        }
                        $(cla).removeClass("show");
                        $(cla + "-back").hide();
                    });
                    window.cla = cla;
                    setTimeout('$(cla).addClass("show")',500);
                    //$(cla).show();
                    $(cla + "-back").show();
                    $(cla + " .close").click(function () {
                        //$(cla).hide();
                        $(cla).removeClass("show");
                        $(cla + "-back").hide();
                        return false;
                    });
                }
            });
        });
            $(".input-search").click(function () {
                var type = $(this).attr("data");
                var thisEle = this;
                var inputs = $(this).parent().find("input");
                var valss = $(inputs).val();
                var otype = $("#o_type").val();
                var olie = $("#o_lie").val();
                var url = "";
                if(type == "contract" || type == "company"){
                    if(type == "company"){
                        if(olie == "2" ){
                            type = "company";
                        }else{
                            type = "department";
                        }
                    }
                    url = baseUrl[type] + "?c_type="+otype+"&fi=1";
                }else{
                    url = baseUrl[type] + "?fi=1";
                }
                var cla = ".f-layer-" + type;
                $.ajax({
                    url: url,
                    dataType: "json",
                    method: "post",
                    success: function (data) {
                        $("#popDIV").html(data.content);
                        $(cla + " .save").click(function () {
                            if($(cla+" .selectRadio:checked").length == 0){
                                custom.alert("请选择一个再保存！");
                                return false;
                            }
                            if ($(inputs).length > 1) {
                                $(inputs).eq(0).val($(cla+" .selectRadio:checked").attr("data"));
                                $(inputs).eq(1).val($(cla+" .selectRadio:checked").val());
                            } else {
                                $(inputs).eq(0).val($(cla+" .selectRadio:checked").val());
                            }
                            if(type == "company" || type == "department"){
                                if ($(inputs).length > 1) {
                                    $("#zc_did").val($(cla + " .selectRadio:checked").attr("data"));
                                    $("#zc_dname").val($(cla + " .selectRadio:checked").val());
                                }else{
                                    $("#zc_did").val("");
                                    $("#zc_dname").val("");
                                }
                            }
                            $(cla).removeClass("show");
                            $(cla + "-back").hide();
                            $(thisEle).parent().find("input:eq(0)").unbind("focus");
                            if(type == "contract" && $(inputs).length > 1){
                                $("#o_status option").prop("selected", false);
                                $("#o_status option").prop("disabled", true);
                                $("#o_status option:last").prop("selected", true);
                                $("#o_status option:last").prop("disabled", false);
                                $("#o_status").prop("", true);
                                var json = JSON.parse(decodeURIComponent($(cla + " .selectRadio:checked").attr("data-value")));
                                if($("#o_money").val() == ""){
                                    $("#o_money").val(json.c_noused);
                                }else{
                                    var nu = parseFloat(json.c_noused),mo = parseFloat($("#o_money").val());
                                    if(nu < mo){
                                        custom.alert("当前订单金额，超过合同的可用金额:"+nu.toFixed(2));
                                        $("#o_money").val(nu.toFixed(2));
                                    }
                                }
                                $("#o_money").attr("max",parseFloat(json.c_noused));
                                if($("#o_pname").val() == ""){
                                    $("#o_pname").val(json.c_pname);
                                    $("#o_pid").val(json.c_pid);
                                }
                                if($("#o_coname").val() == ""){
                                    $("#o_coname").val(json.c_coname);
                                    $("#o_coid").val(json.c_coid);
                                }
                            }
                            return false;
                        });
                        window.cla = cla;
                        setTimeout('$(cla).addClass("show")',500);
                        //$(cla).show();
                        $(cla + "-back").show();
                        $(cla + " .close").click(function () {
                            //$(cla).hide();
                            $(cla).removeClass("show");
                            $(cla + "-back").hide();
                            return false;
                        });
                    }
                });
            });

        $(".fa-minus-square").click(function(){
            var inputs = $(this).parent().next().find("input");
            var type = $(this).attr("data");
            var cla = ".f-layer-" + type;
            if ($(cla).length > 0) {
                $(cla+" .selectRadio:checked").prop("checked", false);
            }
            $(this).prev().show();
            $(this).hide();
            $(inputs).val("");
            if(type == "contract"){
                $("#o_status option").prop("disabled", false);
                $("#o_status option").prop("selected", false);
                $("#o_status option:first").prop("selected", true);
            }
        });
        $("#o_lie").change(function(){
            if($(this).val() == 1){
                $("#o_type option:eq(1)").prop("selected", true);
                $("#o_type option:eq(0)").prop("disabled", true);
            }else{
                $("#o_type option:eq(0)").prop("disabled", false);
            }
            var o_type = $("#o_type").val();
            if($(this).val() == "1" && o_type == "2"){
                zproject.show();
            }else{
                zproject.hide();
            }
            $("#o_coname").val("");
            $("#o_coid").val("");
            $("#o_coname").parent().prev().find("i").eq(1).show();
            $("#o_coname").parent().prev().find("i").eq(2).hide();
        });
        $("#o_cno,#o_pname,#o_coname").each(function(index, element){
            if($(element).val() != ""){
                $(element).parent().prev().find("i:eq(1)").click();
            }
        });
//        $("#o_cno,#o_pname,#o_coname").click(function(){
//            $(this).parent().prev().find("i:eq(0)").click();
//        });
    });
    function baseUTR(element,data,type){
        var i = 1;
        var url = "";
        switch(type){
            case "invoice":
                i=1;
                url = "/#invoice/detail?id="+data.id;
                break;
            case "acceptance":
                i=2;
                url = "/#acceptance/detail?id="+data.id;
                break;
            case "received":
                i=3;
                url = "/#received/detail?id="+data.id;
                break;
        }
        var cla = "."+type+"_"+i;
        var total = parseFloat($("#o_money").val());
        var val = $(element).find(".m_class").val();
        var html = '<tr><td><i class="fa fa-minus-circle" data="'+data.id+'"></i></td>' +
                '<td><?php echo date("Y-m-d"); ?></td>' +
                '<td class="mony-'+type+'">'+parseFloat(val).toFixed(2)+'</td>' +
                '<td><a href="'+url+'" target="_blank" style="color: blue;">'+data.id+'</a>' +
                '<input type="hidden" name="used['+i+'][value][]" value="'+val+'">' +
                '<input type="hidden" name="used['+i+'][date][]" value="'+data.date+'">' +
                '<input type="hidden" name="used['+i+'][ot_id][]" value="'+data.id+'"></td></tr>';
        $(cla).append(html);
        var plus = 0;
        $(cla).find(".mony-"+type).each(function(index, element){
            plus += parseFloat($(element).html());
        });
        var persent = 100-((total-plus)/total*100);
        $(cla).find("tr:first").find("td:eq(2)").html(parseFloat(plus).toFixed(2));
        $(cla).find("tr:first").find("td:eq(3)").html(persent.toFixed(2)+"%");
        bindRemove();
    }
    function bindRemove(){
        $(".fa-minus-circle").unbind("click");
        $(".fa-minus-circle").click(function(){
            var tr = $(this).parents("tr");
            var now = parseFloat($(tr).find("input:eq(0)").val());
            var subTotal = parseFloat($(this).parents("table").find("tr:eq(0)").find("td:eq(2)").html());
            var total = parseFloat($("#o_money").val());
            subTotal = subTotal-now;
            if(subTotal <= 0){
                $(this).parents("table").find("tr:eq(0)").find("td:eq(2)").html("0.00");
                $(this).parents("table").find("tr:eq(0)").find("td:eq(3)").html("0%");
            }else{
                var tmp = 100-((total-subTotal)/total*100);
                $(this).parents("table").find("tr:eq(0)").find("td:eq(2)").html(subTotal.toFixed(2));
                $(this).parents("table").find("tr:eq(0)").find("td:eq(3)").html(Math.round(tmp)+"%");
            }
            $(tr).remove();
        });
    }
    function bindClick(element) {
        var index = $(element).attr('data');
        var baseTR = getBaseTR($(element).attr('data'));
        $(element).append(baseTR);
        if($(".orderProject_percent_"+index).length == 1){
            $(".fa-remove").eq(0).remove();
        }else{
            var tmp = 0;
            $(".orderProject_value_" + index).each(function (index, ele) {
                tmp += parseFloat($(ele).val());
            });
            $(".orderProject_value_" + index).each(function (index, ele) {
                var sl = $(ele).parent().prev().find(".slider");
                var val = parseFloat($(ele).val());
                sliderElement(sl, val, index);
            });
        }
        $(".orderProject_value_" + index).unbind("change");
        $(".orderProject_value_" + index).change(function(){
            valueChange(this);
        });
        $(".fa-remove").unbind("click");
        $(".fa-remove").click(function () {
            $(this).parents("tr").remove();
        });
    }
    function formatValue(value, ele) {
        value = parseFloat(value);
        if (value == 5) {
            $(ele).parent().next().find("input").val("0");
            $(ele).val("0");
            return "0%";
        }
        if (value == "" || value <= 0) {
            $(ele).parent().next().find("input").val("0");
            return "0%";
        }
        var total = parseFloat($("#o_money").val());
        var persent = Math.round(100 - (total - value) / total * 100) + "%";
        $(ele).parent().next().find("input").val(value.toFixed(2));
        return persent;
    }
    function calculateAll() {
        $(".fa-plus").each(function (i, e) {
            var i = $(e).parents("table").attr("data");
            calculate(i);
        });
    }
    function calculate(index) {
        var values = $(".orderProject_value_" + index);
        var percents = $(".orderProject_percent_" + index);
        if(values.length < 1){
            return false;
        }
        var cal = 0;
        var total = parseFloat($("#o_money").val());
        $(values).each(function (i, ele) {
            var tmp = $(ele).val() == "" ? 0 : parseFloat($(ele).val());
            cal = cal + tmp;
        });
        if (!isNaN(total) && total > 0) {
            if (cal > total) {
                if (total % $(values).length != 0) {
                    var c = Math.ceil(total / $(values).length);
                    $(values).eq(0).val(c.toFixed(2));
                    var e = Math.ceil(100 / $(values).length);
                    $(percents).eq(0).val(e.toFixed(2) + "%");
                    $(values).each(function (i, ele) {
                        if (i > 0) {
                            var cc = (total - c) / ($(values).length - 1);
                            $(ele).val(cc.toFixed(2));
                        }
                    });
                    $(percents).each(function (i, ele) {
                        if (i > 0) {
                            var ee = (100 - e) / ($(values).length - 1);
                            $(ele).val(ee.toFixed(2) + "%");
                        }
                    })
                } else {
                    var c = total / $(values).length;
                    var e = 100 / $(values).length;
                    $(values).each(function (i, ele) {
                        $(ele).val(c.toFixed(2));
                    });
                    $(percents).each(function (i, ele) {
                        $(ele).val(e.toFixed(2) + "%");
                    })
                }
            } else {
                $(percents).each(function (i, ele) {
                    var t = parseFloat($(values).eq(i).val());
                    if (!isNaN(t)) {
                        var e = 100 - (total - t) / total * 100;
                        $(ele).val(e.toFixed(2) + "%");
                        $(values).eq(i).val(t.toFixed(2));
                    }
                });
            }
            $("#o_money").val(total.toFixed(2));
        } else {
            $(values).each(function (i, ele) {
                $(ele).val("0.00");
            })
            $(percents).each(function (i, ele) {
                $(ele).val("0.00");
            })
        }
        if($(percents).length == 1){
            sliderElement($(percents).eq(0).prev(), total);
        }else{
            $(percents).each(function(i, ele){
                sliderElement($(ele).prev(), $(ele).parent().next().find("input").val());
            });
        }
    }
    function getBaseTR(index) {
        var baseTr = '<tr><td class="icon"><i class="fa fa-remove"></i></td><td><select class="orderProject_month_' + index + '" name="project[' + index + '][month][]">';
        var bm = JSON.parse(baseMonth);
        var len = bm.length;
        for (var i = 0; i < len; i++) {
            baseTr += '<option value="+' + bm[i] + '">+ ' + bm[i] + '</option>';
        }
        baseTr += '<option value="0 M" selected>0 M</option>';
        for (var i = (len - 1); i >= 0; i--) {
            baseTr += '<option value="-' + bm[i] + '">- ' + bm[i] + '</option>';
        }
        baseTr += '</select></td><td><div class="slider" style="margin: 0 20px;"></div><input type="text" class="orderProject_percent_' + index + ' sliderPercent" style="display: none;" name="project[' + index + '][percent][]" value="0"/></td><td><input class="orderProject_value_' + index + ' sliderValue" name="project[' + index + '][value][]" style="margin-left: 10px;" type="text" value="0"/></td></tr>';
        return baseTr;
    }
    function valueChange(em){
        var parentSlider = $(em).parent().prev().find("input");
        var persent = $(em).parent().prev().find(".slider");
        var val = parseFloat($(em).val().replace(",",""));
        if(isNaN(val) === true){
            custom.alert("计划金额只能是数字");
            $(em).val("0.00");
            sliderElement(persent, "0");
            return false;
        }
        var total = parseFloat($("#o_money").val());
        var classs = $(parentSlider).attr("class").split(" ");
        var now = 0;
        $("."+classs[0]).each(function(index, element){
            if(!$(element).is($(parentSlider))){
                now = now + parseFloat($(element).prev().slider("value"));
            }
        });
        if(total < now){
            $(persent).slider("value", 0);
            $(parentSlider).val(0);
        }else if((total-now) < val){
            val = total-now;
            $(persent).slider("value", val);
            $(parentSlider).val(val);
        }else{
            $(persent).slider("value", val);
            $(parentSlider).val(val);
        }
        sliderElement(persent, val);
    }
    function sliderElement(ele, val){
        if($(ele).slider('instance') != undefined){
            $(ele).slider('destroy');
        }
        var max = $("#o_money").val() == "" ? 0 : $("#o_money").val(), max = parseFloat(max)
            ,className = $(ele).parent().next().find("input").attr("class").split(" ")[0],tt = 0
            ,cn = $(ele).parent().next().find("input");
        $( ele ).slider({
            min: 0,
            max: max,
            value: val,
            create: function (event,ui) {
                p = 0;
                if(max > 0){
                    p = Math.round(100 - (max - val) / max * 100);
                }
                console.log(val);
                $(ele).find("span").css("left", p+"%");
                $(ele).find("span").text(p+"%");
            },
            slide: function (event, ui){
                var value = ui.value, p = Math.round(100 - (max - value) / max * 100)+"%";
                $(ui.handle).text(p);
            },
            stop: function( event, ui ) {
                var total = 0;
                $(ele).parents("table").find(".slider").each(function(index, element){
                    if(!$(element).is($(ele))){
                        total += parseFloat($(element).parent().next().find("input").val());
                    }
                });
                total = max - total;
                var value = parseFloat(ui.value);
                if(value > total){
                    value = total;
                }
                $(ele).parent().next().find("input").val( value.toFixed(2) );
                if(max > 0){
                    var p = Math.round(100 - (max - value) / max * 100)+"%";
                }else{
                    var p = "0%";
                }
                if(parseInt(p.replace(/\%/, "")) <= 0){
                    p = "0%";
                }
                $(ui.handle).prev().css("width", (100-parseInt(p.replace(/\%/, "")))+"%");
                $(ui.handle).css("left", p);
                $(ui.handle).text(p);
            }
        });
        $(ele).parent().next().find("input").val( $( ele ).slider( "value" ).toFixed(2) );
    }
    function initUsed(){
        var base = ["invoice","acceptance","received"],total=parseFloat($("#o_money").val());
        if(total <= 0){
            return false;
        }
        for(var i=0;i<3;i++){
            var ii = i+1,cla = "."+base[i]+"_"+ii,plus=0;
            $(cla).find(".mony-"+base[i]).each(function(index, element){
                plus += parseFloat($(element).html());
            });
            var persent = 100-((total-plus)/total*100);
            $(cla).find("tr:first").find("td:eq(2)").html(parseFloat(plus).toFixed(2));
            $(cla).find("tr:first").find("td:eq(3)").html(persent.toFixed(2)+"%");
        }

    }
</script>
