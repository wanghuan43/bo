<div class="f-layer f-layer-<{$modelName}>-all" style="display: block;">
    <form action="<{if isset($formUrl)}><{$formUrl}><{else}>/<{$modelName}>/all<{/if}>" id="<{$modelName}>AllForm">
        <div class="clearfix header">
            <h2>搜索条件:</h2>
            <div class="btn-pannel">
                <button class="btn red close" type="reset">取消</button>
                <button class="btn search" type="submit">搜索</button>
            </div>
        </div>
        <div class="search-condition clearfix">
            <{for start="0" end="$searchable.length"}>
            <div class="search-block">
                <select class="fields" name="fields[<{$modelName}>][<{$i}>]">
                    <?php $ii=0;foreach($searchable['fields'] as $key=>$value): ?>
                    <option value="<{$key}>" <{eq name="$ii" value="$i"}>selected<{/eq}> data="<{$value.type}>"><{$value.name}></option>
                    <?php $ii++; ?>
                    <?php endforeach ?>
                </select>
                <select class="operators" name="operators[<{$modelName}>][<{$i}>]">
                </select>
                <input type="text" id="<?php echo "tmp",mt_rand(1000,100000); ?>" name="values[<{$modelName}>][<{$i}>][]" value=""/>
            </div>
            <{/for}>
        </div>
    </form>
    <div id="<{$modelName}>List">
    </div>
</div>

<script>
    var operators<{$modelName}> = <?php echo json_encode($searchable['operators']); ?>;
    var fields<{$modelName}> = <?php echo json_encode($searchable['fields']); ?>;
    var datePlugin = {};
    $(document).ready(function(){
        $('.f-layer-<{$modelName}>-all .fields').change(function(){
            var val = $(this).val();
            var lists = eval("operators<{$modelName}>."+val);
            var opt = "";
            for(var i in lists){
                opt += "<option value=\""+i+"\">"+lists[i]+"</option>";
            }
            $(this).next().html(opt);
            operatorsChange($(this).next());
        });
        $('.f-layer-<{$modelName}>-all  .operators').change(function(){
            operatorsChange(this);
        });
        $('.f-layer-<{$modelName}>-all  .fields').change();

        $("#<{$modelName}>AllForm").submit(function() {
            var data = $(this).serialize();
            var url = $(this).attr("action");
            var tt = {
                url: url,
                dataType: "json",
                method: "post",
                data: data,
                };
            contentAjax("main-container", tt, 'jump');
            return false;
        });

        });
    function operatorsChange(ele){
        var opt = $(ele).val();
        var type = $(ele).prev().find("option:selected").attr("data");
        var id = '#'+$(ele).parent().find("input").attr("id");
        var input = $(ele).parent().find("input");
        switch (type){
            case 'date':
                setDateField(id, opt, input);
                break;
            case 'type':
                setTypeField(id,opt,input);
                break;
            default:
                cutInput(input,opt,type);
                break;
        }
    }
    function cutInput(input,opt,type){
        $(input).attr("fliter", type);
        $(input).val("");
        var tmp = $(input).clone();
        var id = $(input).attr("id");
        var inputs = $(input).parent().find("input");
        var it = id.replace("#","");
        var parent = $(input).parent();
        if(type != "date"){
            if(datePlugin[it] != undefined) {
                delete datePlugin[it];
                $(input).remove();
                $(parent).append(tmp);
            }
            $(input).removeAttr("readonly");
            if(opt=="between"){
                $(input).css("width", "100px");
                $(input).attr("id", id+"-1");
                $(tmp).css("width", "100px");
                $(tmp).attr("id", id+"-2");
                $(input).parent().append(tmp);
            }else{
                if(inputs.length > 1){
                    $(inputs).eq("1").remove();
                    $(input).css("width", "200px");
                    $(input).attr("id", id.replace("-1", ""));
                }
            }
        }else{
            $(input).attr("readonly");
            var inputs = $(input).parent().find("input");
            if(inputs.length > 1){
                $(inputs).eq("1").remove();
                $(input).css("width", "200px");
                $(input).attr("id", id.replace("-1", ""));
            }
        }
    }
    function setDateField(id,opt,input){
        var range = false;
        var it = id.replace("#","");
        var val = $(input).val();
        if(opt == "between"){
            range = "~";
        }
        if(datePlugin[it] != undefined){
            datePlugin[it].config.range = range;
            if(range === false && val.indexOf("~") > 0){
                $(input).val(val.substr(0, val.indexOf("~")-1));
            }else if(range !== false && val.indexOf("~") < 0){
                $(input).val("");
            }
        }else{
            var tmp = laydate.render({
                elem:id,
                range:range,
                value:val,
                format: 'yyyy-MM-dd'
            });
            datePlugin[it] = tmp;
        }
    }
    function setTypeField(id,opt,input) {
        var name = $(id).attr("name");
        var pNode = $(id).parent();
        $(id).remove();
        var sel  = "<select name='"+name+"' id='"+id+"' style='width:200px;'>" +
            "<option value=''>--</option>" +
            "<option value='1'>销售</option>" +
            "<option value='2'>采购</option>" +
            "</select>";
        console.log(sel);
        pNode.append(sel);
    }
</script>
