<!-- 弹窗 START -->
<div class="f-layer-<{$type}>-back"
     style="display:none;background-color: black;opacity: 0.5;width: 100%;height: 100%;position: fixed;top: 0;"></div>
<div class="f-layer f-layer-<{$type}>" style="display: none;">
    <form action="<{:url("/$type/search".ucfirst($type))}>" id="<{$type}>Form">
    <div class="clearfix header">
        <h2>搜索条件:</h2>
        <div class="btn-pannel">
            <button class="btn save" type="reset">保存</button>
            <button class="btn red close" type="reset">取消</button>
            <button class="btn search" type="submit">搜索</button>
        </div>
    </div>
    <div class="search-condition">
        <{for start="0" end="$searchable.length"}>
        <div class="search-block">
            <select class="fields" name="fields[<{$type}>][<{$i}>]">
                <?php $ii=0;foreach($searchable['fields'] as $key=>$value): ?>
                <option value="<{$key}>" <{eq name="$ii" value="$i"}>selected<{/eq}> data="<{$value.type}>"><{$value.name}></option>
                <?php $ii++; ?>
                <?php endforeach ?>
            </select>
            <select class="operators" name="operators[<{$type}>][<{$i}>]">
            </select>
            <input type="text" id="<?php echo "tmp",mt_rand(1000,100000); ?>" name="values[<{$type}>][<{$i}>][]" value=""/>
        </div>
        <{/for}>
    </div>
    </form>
    <div id="<{$type}>List">
    </div>
</div>
<!-- 弹窗 END -->
<script>
    var operators = <?php echo json_encode($searchable['operators']); ?>;
    var fields = <?php echo json_encode($searchable['fields']); ?>;
    var datePlugin = {};
    $(document).ready(function(){
        $('.fields').change(function(){
            var val = $(this).val();
            var lists = eval("operators."+val);
            var opt = "";
            for(var i in lists){
                opt += "<option value=\""+i+"\">"+lists[i]+"</option>";
            }
            $(this).next().html(opt);
            operatorsChange($(this).next());
        });
        $('.operators').change(function(){
            operatorsChange(this);
        });
        $('.fields').change();
        $("#<{$type}>Form").submit(function() {
            var data = $(this).serialize();
            var url = $(this).attr("action");
            var tt = {
                url: url,
                dataType: "json",
                method: "post",
                data: data,
                success:function(data){
                    $("#<{$type}>List").html(data.content);
                    $("#<{$type}>List a").click(function(){
                        var href = $(this).attr("href");
                        if(href != "" && href != "#"){
                            href = href.replace("#", "/");
                            var tts = {
                                url: href,
                                method: "get",
                                dataType:"json"
                            }
                            contentAjax(href, "<{$type}>List", tts);
                        }
                        return false;
                    });
                }
            };
            contentAjax(url, "<{$type}>List", tt);
            return false;
        });
        $("#<{$type}>Form").submit();
    });
    function operatorsChange(ele){
        var opt = $(ele).val();
        var type = $(ele).prev().find("option:selected").attr("data");
        var id = '#'+$(ele).parent().find("input").attr("id");
        var input = $(ele).parent().find("input");
        switch (type){
            case 'date':
                setDateField(id, opt, input);
            default:
                cutInput(input,opt,type);
                break;
        }
    }
    function cutInput(input,opt,type){
        $(input).attr("fliter", type);
        $(input).val("");
        var tmp = $(input).clone();
        var id = $(input).attr("id");
        var inputs = $(input).parent().find("input");
        var it = id.replace("#","");
        var parent = $(input).parent();
        if(type != "date"){
            if(datePlugin[it] != undefined) {
                delete datePlugin[it];
                $(input).remove();
                $(parent).append(tmp);
            }
            $(input).removeAttr("readonly");
            if(opt=="between"){
                $(input).css("width", "100px");
                $(input).attr("id", id+"-1");
                $(tmp).css("width", "100px");
                $(tmp).attr("id", id+"-2");
                $(input).parent().append(tmp);
            }else{
                if(inputs.length > 1){
                    $(inputs).eq("1").remove();
                    $(input).css("width", "200px");
                    $(input).attr("id", id.replace("-1", ""));
                }
            }
        }else{
            $(input).attr("readonly");
            var inputs = $(input).parent().find("input");
            if(inputs.length > 1){
                $(inputs).eq("1").remove();
                $(input).css("width", "200px");
                $(input).attr("id", id.replace("-1", ""));
            }
        }
    }
    function setDateField(id,opt,input){
        var range = false;
        var it = id.replace("#","");
        var val = $(input).val();
        if(opt == "between"){
            range = "~";
        }
        if(datePlugin[it] != undefined){
            datePlugin[it].config.range = range;
            if(range === false && val.indexOf("~") > 0){
                $(input).val(val.substr(0, val.indexOf("~")-1));
            }else if(range !== false && val.indexOf("~") < 0){
                $(input).val("");
            }
        }else{
            var tmp = laydate.render({
                elem:id,
                range:range,
                value:val
            });
            datePlugin[it] = tmp;
        }
    }
</script>